# 游戏统计信息自动更新功能

## 功能概述

该功能实现了在用户登录成功后自动更新JSON数据文件中的游戏统计信息，包括：
- `gameCount`（游戏场数）
- `gameBalance`（游戏余额）
- `lastUpdateTime`（最后更新时间）

## 实现原理

### 1. 登录流程增强
- 在原有的批量登录验证基础上，增加了登录成功后的回调处理
- 当用户登录成功时，自动从服务器响应中提取最新的游戏统计数据
- 将提取的数据更新到对应的JSON文件中

### 2. 数据提取
从登录API响应中提取以下字段：
- `response.d.ls` → `gameCount`（游戏场数）
- `response.d.bv` → `gameBalance`（游戏余额）

### 3. 文件更新机制
- 自动查找包含指定UID的JSON文件
- 更新对应账号的游戏统计信息
- 添加最后更新时间戳
- 保持其他数据不变

## 使用方法

### 通过CLI界面
1. 运行主程序：`node src/core/cli.js`
2. 选择选项 `2` - "验证登录"
3. 系统将自动：
   - 读取所有JSON文件中的账号
   - 逐个进行登录验证
   - 登录成功后自动更新游戏统计信息

### 程序化调用
```javascript
import { handleAuth } from './src/app/handlers/auth.js';

// 执行登录并自动更新游戏统计信息
const result = await handleAuth.login();
console.log(`登录成功: ${result.success.length}/${result.total}`);
```

## 更新的文件结构

### 更新前
```json
[
  {
    "uid": "7167630881967116",
    "email": "lionel@gmail.com",
    "nickname": "lionel",
    "registerTime": "2025/7/24 11:54:24"
  }
]
```

### 更新后
```json
[
  {
    "uid": "7167630881967116",
    "email": "lionel@gmail.com",
    "nickname": "lionel",
    "registerTime": "2025/7/24 11:54:24",
    "gameCount": "25",
    "gameBalance": "50000",
    "lastUpdateTime": "2025/7/25 17:31:55"
  }
]
```

## 新增的核心函数

### `updateAccountGameStats(uid, gameCount, gameBalance, email)`
- **功能**：更新指定账号的游戏统计信息
- **参数**：
  - `uid`: 用户ID
  - `gameCount`: 游戏场数
  - `gameBalance`: 游戏余额
  - `email`: 用户邮箱（可选，用于日志）
- **返回值**：包含成功状态和相关信息的对象

### `processBatchWithUpdate(accounts, processor, successChecker, updateCallback, operationName)`
- **功能**：增强版批处理器，支持成功后回调
- **特点**：在原有批处理基础上增加了成功后的更新回调机制

## 错误处理

- 如果JSON文件不存在，会返回相应错误信息
- 如果找不到指定UID的账号，会记录错误但不影响其他账号的处理
- 网络错误或API响应异常时，会跳过更新但记录错误日志
- 文件写入失败时会记录详细错误信息

## 日志输出示例

```
总共读取到 2 个账号
✅ 登录成功！用户: lionel@gmail.com
✅ 已更新账号 lionel@gmail.com 的游戏统计信息 - 文件: 2025-7-23.json
   游戏场数: 25, 游戏余额: 50000
✅ 登录成功！用户: lionelss@gmail.com
✅ 已更新账号 lionelss@gmail.com 的游戏统计信息 - 文件: 2025-7-23.json
   游戏场数: 18, 游戏余额: 32000
成功: 2
失败: 0
```

## 注意事项

1. **数据一致性**：更新操作是原子性的，要么完全成功要么完全失败
2. **文件备份**：建议在大批量更新前备份JSON文件
3. **网络稳定性**：确保网络连接稳定，避免登录过程中断
4. **权限检查**：确保程序对JSON文件目录有读写权限

## 兼容性

- 该功能完全向后兼容，不会影响现有的登录验证流程
- 对于已经包含游戏统计信息的账号，会更新为最新值
- 对于缺少这些字段的账号，会自动添加相应字段
